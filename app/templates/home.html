<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple CRUD</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <header>
      <div class="px-4 py-5 my-5">
        <div class="text-center">
          <h1 class="display-5 fw-bold text-body-emphasis">Simple CRUD app</h1>
          <div class="col-lg-6 mx-auto">
            <p class="lead mb-4">
              Aplikasi Create Read Update Delete (CRUD) sederhana berbasis
              FastAPI & SQLModel, dengan database SQL seperti PostgreSQL.
              Aplikasi ini menjadi penugasan portofolio pendaftaran staf
              <a href="https://instagram.com/ara_its">ARA 7.0</a> divisi IT Dev,
              bagian Backend.
            </p>
          </div>
        </div>

        <div class="container">
          <div class="alert alert-success" role="alert">
            <h4 class="alert-heading">Dokumentasi API</h4>
            <p>
              Dokumentasi REST API berbasis Swagger dapat diakses di
              <a href="/docs">/docs</a>.
            </p>
            <hr />
            <p class="mb-0">Contoh web UI sederhana dapat diakses di bawah.</p>
          </div>
        </div>
      </div>
    </header>
    <main>
      <div class="container">
        <div class="row">
          <div class="col-lg-6">
            <h3>Peserta:</h3>
            <div id="peserta">
              <i>Loading wak...</i>
            </div>
          </div>
          <div class="col-lg-6">
            <form>
              <div class="mb-3">
                <label for="nama" class="form-label">Nama</label>
                <input type="text" class="form-control" name="nama" required />
              </div>
              <div class="mb-3">
                <label for="sekolah" class="form-label">Sekolah</label>
                <input
                  type="text"
                  class="form-control"
                  name="sekolah"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                tambah banh (jangan di XSS wak)
              </button>
            </form>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <script>
        function checkIfEmpty(elements) {
          //   Ugly way to avoid sending empty fields
          let body = {};
          for (let i = 0; i < elements.length; i++) {
            if (elements[i][1] != "" && elements[i][1] != null) {
              body[elements[i][0]] = elements[i][1];
            }
          }
          return body;
        }

        async function fetchPeserta() {
          const response = await fetch("/peserta/");
          const data = await response.json();
          const pesertaDiv = document.getElementById("peserta");
          pesertaDiv.innerHTML = "";

          pesertaUl = document.createElement("ul");

          data.forEach((peserta) => {
            const list = document.createElement("li");
            list.textContent = `${peserta.nama} (${peserta.sekolah})`;
            list.setAttribute("data-id", peserta.id);
            pesertaUl.appendChild(list);
          });
          pesertaDiv.appendChild(pesertaUl);
        }

        async function addPeserta(nama, sekolah) {
          var body = checkIfEmpty([
            ["nama", nama],
            ["sekolah", sekolah],
          ]);
          if (!body.nama || !body.sekolah) {
            alert("Nama dan sekolah wajib diisi!");
            return false;
          }

          const response = await fetch("/peserta/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          });
          return response.ok;
        }

        async function editPeserta(id, nama, sekolah) {
          var body = checkIfEmpty([
            ["nama", nama],
            ["sekolah", sekolah],
          ]);

          const response = await fetch(`/peserta/${id}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          });
          return response.ok;
        }

        async function deletePeserta(id) {
          const response = await fetch(`/peserta/${id}`, {
            method: "DELETE",
          });
          return response.ok;
        }

        // Utils
        function addEditButtons() {
          const pesertaUl = document.querySelector("#peserta ul");
          if (!pesertaUl) return;

          const listItems = pesertaUl.querySelectorAll("li");

          listItems.forEach((item) => {
            const editBtn = document.createElement("button");
            editBtn.textContent = "Edit";
            editBtn.classList.add("btn", "btn-warning", "btn-sm", "ms-2");
            editBtn.addEventListener("click", () => {
              const id = item.getAttribute("data-id");
              const newName = prompt("Masukkan nama baru:");
              const newSchool = prompt("Masukkan sekolah baru:");
              if (newName || newSchool) {
                // Call update API here
                editPeserta(id, newName, newSchool).then((success) => {
                  if (success) {
                    alert("Berhasil mengupdate peserta");
                    window.location.reload();
                  } else {
                    alert("Gagal mengupdate peserta");
                  }
                });
              }
            });
            item.appendChild(editBtn);
          });
        }

        function addDeleteButtons() {
          const pesertaUl = document.querySelector("#peserta ul");
          if (!pesertaUl) return;

          const listItems = pesertaUl.querySelectorAll("li");

          listItems.forEach((item) => {
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Hapus";
            deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "ms-2");
            deleteBtn.addEventListener("click", () => {
              const id = item.getAttribute("data-id");
              deletePeserta(id).then((success) => {
                if (success) {
                  alert("Berhasil menghapus peserta");
                  window.location.reload();
                } else {
                  alert("Gagal menghapus peserta");
                }
              });
            });
            item.appendChild(deleteBtn);
          });
        }

        // Tombol: tambah banh
        document
          .getElementById("submitBtn")
          .addEventListener("click", async (e) => {
            e.preventDefault();
            const nama = document.querySelector("input[name='nama']").value;
            const sekolah = document.querySelector(
              "input[name='sekolah']"
            ).value;

            addPeserta(nama, sekolah).then((success) => {
              if (success) {
                alert("Berhasil menambahkan peserta");
                window.location.reload();
              } else {
                alert("Gagal menambahkan peserta");
              }
            });
          });

        document.addEventListener("DOMContentLoaded", async () => {
          await fetchPeserta();
          addEditButtons();
          addDeleteButtons();
        });
      </script>
    </footer>
  </body>
</html>
